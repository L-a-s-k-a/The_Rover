#include "interrupt.h"

uint16_t TickDelayCount, miiliseconds;
uint8_t FLAG_Delay;

void SysTick_Handler(void)
{
    GlobalTickCount++;
    if (FLAG_Delay)
        TickDelayCount++;
}

void ADC_IRQHandler(void){
    adcInter = ADC1->DR;
    // SET_BIT(ADC1->CR2, ADC_CR2_SWSTART);
}

void DMA2_Stream0_IRQHandler(void){
    if (READ_BIT(DMA2->LISR, DMA_LISR_TCIF0))
    {
        SET_BIT(DMA2->LIFCR, DMA_LIFCR_CTCIF0); // Очистка флага прерывания
        adc_conversion_complete = 1; // Установка флага готовности данных
        GPIOA->ODR ^= (0 << 6); // Переключение бита 6 порта A
    }
    // Диагностика: проверка переполнения АЦП
    if (ADC1->SR & ADC_SR_OVR) {
        adc_overrun_count++;
        ADC1->SR &= ~ADC_SR_OVR; // Сбрасываем флаг
        // Зажжем красный светодиод, если есть
        // GPIOA->ODR ^= (0 << 6); // Переключение бита 6 порта A
    }
}

void TIM3_IRQHandler(void){
    if (READ_BIT(TIM3->SR, TIM_SR_UIF))
    {
        TIM3->SR &= ~TIM_SR_UIF; // Очистка флага прерывания
        TickDelayCount++;
        if(TickDelayCount >= 1000){
            TickDelayCount = 0;
            miiliseconds++;
        }
    }
}

void delay(int del)
{
    FLAG_Delay = 1;
    while (TickDelayCount < del)
    {
    }
    TickDelayCount = 0;
    FLAG_Delay = 0;
}
